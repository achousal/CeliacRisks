# Training Configuration - Level 3 (Production / Overnight HPC)
# Full Optuna budget (100 trials), maximum statistical power.
# Goal: definitive model selection, publication-ready results.
#
# NOTE: Refine Optuna ranges based on L2 results before launching.
# Tighten ranges where L2 best params concentrate for denser sampling.

scenario: IncidentPlusPrevalent

# Cross-validation: full budget
cv:
  folds: 5
  repeats: 10          # full statistical power
  inner_folds: 5
  scoring: roc_auc
  # n_iter: 2  # Global override: if set, overrides ALL per-model n_iter values below
  n_jobs: -1
  random_state: 42
  grid_randomize: true
  verbose: 1

# Ensemble (trained separately via train-ensemble CLI after base models)
ensemble:
  method: stacking
  base_models: [LR_EN, RF, XGBoost, LinSVM_cal]
  meta_model:
    type: logistic_regression
    penalty: l2
    C: 1.0
    max_iter: 1000
    solver: lbfgs
  use_probabilities: true
  passthrough: false
  cv_for_meta: 5

# Optuna: proper Bayesian optimization
optuna:
  enabled: true
  n_trials: 100                # full budget for convergence
  timeout: null
  sampler: tpe
  sampler_seed: 42
  pruner: hyperband
  pruner_n_startup_trials: 15  # generous warmup
  pruner_percentile: 20.0      # slightly more aggressive pruning
  n_jobs: -1
  save_study: true
  save_trials_csv: true

# Feature selection: same as L2 (refine k_grid based on L2 convergence)
features:
  feature_select: hybrid
  kbest_scope: protein
  kbest_max: 800
  k_grid: [25, 50, 100, 150, 200, 300, 400, 600, 800]
  l1_c_min: 0.001
  l1_c_max: 1.0
  l1_c_points: 4
  l1_stability_thresh: 0.70
  hybrid_kbest_first: true
  hybrid_k_for_stability: 200
  screen_method: mannwhitney
  screen_top_n: 1000
  stability_thresh: 0.70
  stable_corr_thresh: 0.85

# Logistic Regression (ElasticNet): same ranges as L2
lr:
  C_min: 0.0001
  C_max: 10.0
  C_points: 20
  l1_ratio: [0.0, 0.05, 0.1, 0.15, 0.2, 0.3, 0.5, 0.7, 0.9, 1.0]
  class_weight_options: "balanced"
  optuna_C: [1.0e-5, 100.0]
  optuna_l1_ratio: [0.0, 1.0]
  solver: saga
  max_iter: 10000
  n_iter: 4

# Linear SVM
svm:
  C_min: 0.0001
  C_max: 10.0
  C_points: 15
  class_weight_options: "balanced"
  optuna_C: [1.0e-4, 100.0]
  max_iter: 10000
  n_iter: 6

# Random Forest: same ranges as L2
rf:
  n_estimators_grid: [100, 300, 500, 700]
  max_depth_grid: [null, 10, 20, 30, 50]
  min_samples_split_grid: [2, 5, 10, 20]
  min_samples_leaf_grid: [1, 2, 4, 8]
  max_features_grid: ["sqrt", "log2", 0.3, 0.5, 0.7]
  class_weight_options: "balanced"
  optuna_n_estimators: [100, 800]
  optuna_max_depth: [5, 50]
  optuna_min_samples_split: [2, 30]
  optuna_min_samples_leaf: [1, 15]
  optuna_max_features: [0.05, 0.8]
  n_iter: 2

# XGBoost: same ranges as L2
xgboost:
  n_estimators_grid: [100, 200, 400, 800, 1200]
  max_depth_grid: [3, 4, 5, 6, 7, 8]
  learning_rate_grid: [0.01, 0.03, 0.05, 0.1, 0.2]
  subsample_grid: [0.5, 0.7, 0.85, 1.0]
  colsample_bytree_grid: [0.3, 0.5, 0.7, 0.85, 1.0]
  scale_pos_weight_grid: [3.0, 5.0, 6.0, 7.0, 10.0]
  min_child_weight_grid: [1, 2, 4, 6, 10]
  gamma_grid: [0.0, 0.05, 0.1, 0.5, 1.0, 2.0]
  reg_alpha_grid: [0.0, 0.001, 0.01, 0.1, 1.0]
  reg_lambda_grid: [0.01, 0.1, 1.0, 5.0, 10.0, 50.0]
  optuna_n_estimators: [50, 1500]
  optuna_max_depth: [3, 10]
  optuna_learning_rate: [0.005, 0.3]
  optuna_min_child_weight: [0.1, 20.0]
  optuna_gamma: [0.0, 2.0]
  optuna_subsample: [0.5, 1.0]
  optuna_colsample_bytree: [0.3, 1.0]
  optuna_reg_alpha: [1.0e-8, 10.0]
  optuna_reg_lambda: [1.0e-2, 50.0]
  tree_method: hist
  n_iter: 2

# Calibration: OOF-posthoc (unbiased)
calibration:
  enabled: true
  strategy: oof_posthoc
  method: isotonic
  cv: 5

# Thresholding
thresholds:
  objective: fixed_spec
  fixed_spec: 0.95
  fbeta: 1.0
  fixed_ppv: 0.10
  threshold_source: val
  target_prevalence_source: test
  target_prevalence_fixed: null
  risk_prob_source: test

# Evaluation: full budget for publication
evaluation:
  test_ci_bootstrap: true
  n_boot: 1000                 # narrow CIs for publication
  boot_random_state: 0
  learning_curve: true
  lc_train_sizes: [0.1, 0.25, 0.5, 0.75, 1.0]
  feature_reports: true
  feature_report_max: 200
  control_spec_targets: [0.90, 0.95, 0.99]
  toprisk_fracs: [0.01, 0.05, 0.10]

# DCA
dca:
  compute_dca: true
  dca_threshold_min: 0.0005
  dca_threshold_max: 1.0
  dca_threshold_step: 0.001
  dca_report_points: [0.01, 0.05, 0.10, 0.20]

# Outputs: everything enabled for final run
output:
  save_train_preds: true
  save_train_oof: true
  save_val_preds: true
  save_test_preds: true
  save_calibration: true
  calib_bins: 6
  save_controls_oof: true
  save_feature_importance: true
  feature_reports: true
  plot_format: png
  plot_dpi: 300
  save_plots: true
  plot_roc: true
  plot_pr: true
  plot_calibration: true
  plot_risk_distribution: true
  plot_dca: true
  plot_learning_curve: true
  plot_oof_combined: true
  plot_optuna: true
